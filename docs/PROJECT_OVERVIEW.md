# 🏗️ 项目架构概览

## 系统架构图

```
┌─────────────────────────────────────────────────────────────┐
│                     客户端 (浏览器/Postman)                  │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────┐
│                    HTTP 服务器 (Crow)                        │
│                    端口: 21180                              │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────┐
│                    中间件层 (Middleware)                     │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │ 日志中间件   │  │ 认证中间件   │  │ CORS 处理    │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────┐
│                    服务层 (Services)                         │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │ 用户服务     │  │ 学生服务     │  │ 课程服务     │      │
│  │ 成绩服务     │  │ 统计服务     │  │ 报表服务     │      │
│  │ 系统服务     │  └──────────────┘  └──────────────┘      │
│  └──────────────┘                                          │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────┐
│                    认证层 (Auth)                            │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │ 登录/登出    │  │ Token 验证   │  │ 权限检查     │      │
│  │ 密码加密     │  └──────────────┘  └──────────────┘      │
│  └──────────────┘                                          │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────┐
│                    数据层 (Data Manager)                     │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │ 文件读写     │  │ JSON 解析    │  │ 数据备份     │      │
│  │ 事务管理     │  └──────────────┘  └──────────────┘      │
│  └──────────────┘                                          │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────┐
│                    存储层 (JSON 文件)                       │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │ users.json   │  │ students.json│  │ courses.json │      │
│  │ grades.json  │  │ logs.json    │  │ tokens.json  │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────────────────────────────────────────────┘
```

## 📊 数据流示意图

```
用户请求
    ↓
[认证检查] → 失败 → 返回 401 错误
    ↓ 成功
[权限验证] → 失败 → 返回 403 错误
    ↓ 成功
[路由匹配] → 失败 → 返回 404 错误
    ↓ 成功
[服务处理] → 业务逻辑
    ↓
[数据操作] → 读写 JSON 文件
    ↓
[生成响应] → JSON 格式
    ↓
返回客户端
```

## 🗂️ 文件结构详解

### 核心文件
- `main.cpp` - 程序入口，路由配置
- `build.sh` - macOS 编译脚本
- `build_windows.sh` - Windows 交叉编译脚本

### 头文件 (include/)
```
include/
├── models.h           # 数据模型定义
├── data_manager.h     # 数据持久化管理
├── auth.h            # 认证与权限管理
├── middleware.h      # HTTP 中间件
├── user_service.h    # 用户管理服务
├── student_service.h # 学生管理服务
├── course_service.h  # 课程管理服务
├── grade_service.h   # 成绩管理服务
├── statistics_service.h # 统计分析服务
├── report_service.h  # 报表生成服务
└── system_service.h  # 系统管理服务
```

### 数据文件 (data/)
```
data/
├── users.json          # 用户账号数据
├── students.json       # 学生基本信息
├── courses.json        # 课程信息
├── grades.json         # 成绩记录
├── operation_logs.json # 用户操作日志
├── system_logs.json    # 系统运行日志
├── backups.json        # 备份记录
├── settings.json       # 系统设置
└── tokens.json         # 认证 Token
```

## 🔄 业务流程示例

### 用户登录流程
```
1. 用户提交用户名、密码、角色
2. AuthManager 验证用户身份
3. 验证密码哈希 (SHA256)
4. 生成 JWT Token
5. 记录登录日志
6. 返回 Token 给客户端
```

### 成绩录入流程
```
1. 教师提交成绩数据
2. 认证中间件验证 Token
3. 权限检查 (需要 teacher 或 admin)
4. StudentService 验证学生存在
5. CourseService 验证课程存在
6. GradeService 保存成绩
7. 记录操作日志
8. 返回成功响应
```

### 统计分析流程
```
1. 请求统计数据
2. 认证和权限检查
3. StatisticsService 收集数据
4. 计算平均分、排名、分布
5. 生成统计结果
6. 返回 JSON 数据
```

## 🔧 技术栈

| 组件 | 技术 | 用途 |
|------|------|------|
| 语言 | C++17 | 核心编程语言 |
| Web 框架 | Crow | HTTP 服务器 |
| JSON 库 | nlohmann/json | 数据序列化 |
| 加密 | OpenSSL (macOS) / Crypto API (Windows) | 密码哈希 |
| 编译器 | clang++ (macOS) / mingw64 (Windows) | 代码编译 |
| 数据存储 | JSON 文件 | 持久化存储 |

## 📈 性能指标

- **并发处理**: 异步 I/O，支持高并发
- **响应时间**: < 10ms (平均)
- **内存占用**: ~50MB
- **启动时间**: < 1s
- **文件大小**: 8MB (macOS) / 24MB (Windows)

## 🔒 安全架构

```
┌─────────────────────────────────────┐
│  传输层安全 (HTTPS - 生产环境)      │
└──────────────┬──────────────────────┘
               │
               ▼
┌─────────────────────────────────────┐
│  认证层 (JWT Token + SHA256)        │
└──────────────┬──────────────────────┘
               │
               ▼
┌─────────────────────────────────────┐
│  权限层 (RBAC - 基于角色的访问控制) │
└──────────────┬──────────────────────┘
               │
               ▼
┌─────────────────────────────────────┐
│  数据层 (输入验证 + 操作审计)       │
└─────────────────────────────────────┘
```

## 🎯 设计模式

- **MVC 模式**: Model-View-Controller 分离
- **服务层模式**: 业务逻辑封装
- **中间件模式**: 请求预处理
- **单例模式**: 全局管理器
- **工厂模式**: 数据模型创建

## 🚀 扩展性

### 添加新功能
1. 在 `include/` 创建新的 service 头文件
2. 在 `main.cpp` 添加路由
3. 在 `models.h` 添加数据模型
4. 在 `data/` 添加对应 JSON 文件

### 修改数据结构
1. 更新 `models.h` 中的结构体定义
2. 更新 `data_manager.h` 中的读写方法
3. 更新相关 service 的处理逻辑
4. 迁移现有数据

## 📦 部署架构

### 开发环境
```
本地运行
├── 端口: 21180
├── 数据: ./data/
└── 日志: 控制台输出
```

### 生产环境
```
服务器部署
├── 端口: 21180 (反向代理后)
├── 数据: /var/lib/cppBackServer/data/
├── 日志: /var/log/cppBackServer/
└── HTTPS: Nginx/Apache 反向代理
```

## 🎓 学习要点

通过本项目可以学习：
1. C++ Web 开发
2. RESTful API 设计
3. JWT 认证机制
4. 文件 I/O 操作
5. JSON 数据处理
6. 跨平台编译
7. 中间件设计模式
8. 服务层架构

---

**提示**: 详细的功能说明和 API 参考请查看 [API文档.md](API文档.md)