# 学生选课功能后端实现说明

## 概述

本次更新为学生成绩管理系统后端添加了学生选课功能，以支持前端新增的选课管理界面。后端使用 C++ 和 Crow 框架实现，通过 RESTful API 提供服务。

## 新增 API 接口

### 1. 学生选课
- **路径**: `POST /api/courses/<courseId>/enroll`
- **权限**: 管理员、教师
- **请求体**:
```json
{
  "studentId": "2024001"
}
```
- **响应**:
```json
{
  "message": "Enrollment successful",
  "student": {
    "studentId": "2024001",
    "name": "李明",
    "class": "计算机2401"
  },
  "course": {
    "courseId": "CS101",
    "name": "计算机基础"
  }
}
```

### 2. 取消选课
- **路径**: `DELETE /api/courses/<courseId>/enroll/<studentId>`
- **权限**: 管理员、教师
- **响应**:
```json
{
  "message": "Unenrollment successful",
  "student": {
    "studentId": "2024001",
    "name": "李明"
  },
  "course": {
    "courseId": "CS101",
    "name": "计算机基础"
  }
}
```

### 3. 获取选课学生列表（已存在）
- **路径**: `GET /api/courses/<courseId>/students`
- **权限**: 所有认证用户
- **响应**: 学生数组，包含学号、姓名、班级和成绩

## 技术实现细节

### 数据模型
- **选课记录**: 使用现有的 `Grade` 模型存储选课关系
- **初始成绩**: 选课时自动创建成绩记录，初始分数为 0
- **成绩管理**: 通过成绩记录的增删来管理选课关系

### 权限控制
- **选课操作**: 仅管理员和教师可以执行
- **查看选课**: 所有认证用户都可以查看
- **取消选课**: 仅管理员和教师可以执行

### 业务逻辑
1. **选课验证**:
   - 检查课程是否存在
   - 检查学生是否存在
   - 检查是否已经选课（防止重复）

2. **取消选课验证**:
   - 检查课程是否存在
   - 检查学生是否存在
   - 检查选课记录是否存在

3. **数据一致性**:
   - 选课操作自动创建成绩记录
   - 取消选课自动删除成绩记录
   - 操作日志自动记录

## 文件修改

### 1. `include/course_service.h`
添加了两个新方法：
- `enrollStudent()`: 处理学生选课逻辑
- `unenrollStudent()`: 处理取消选课逻辑

### 2. `main.cpp`
添加了两个新路由：
- `POST /api/courses/<courseId>/enroll`
- `DELETE /api/courses/<courseId>/enroll/<studentId>`

### 3. `API文档.md`
更新了 API 文档，添加了新的接口说明和路由编号。

## 测试验证

运行 `test_enrollment.sh` 脚本可以验证所有功能：
1. ✅ 登录获取 Token
2. ✅ 创建测试课程
3. ✅ 创建测试学生
4. ✅ 学生选课
5. ✅ 查看选课学生列表
6. ✅ 取消选课
7. ✅ 验证选课列表为空
8. ✅ 清理测试数据

## 与前端的配合

### 前端需要调用的 API：
1. **添加选课**: `POST /api/courses/{courseId}/enroll`
2. **取消选课**: `DELETE /api/courses/{courseId}/enroll/{studentId}`
3. **查看选课学生**: `GET /api/courses/{courseId}/students`

### 权限处理：
- 前端需要根据用户角色显示/隐藏选课操作按钮
- 管理员和教师可以看到"添加选课"和"取消选课"按钮
- 学生只能查看选课信息

### 数据同步：
- 选课操作后，前端可以调用 `GET /api/grades` 刷新成绩列表
- 选课操作后，前端可以调用 `GET /api/courses/{courseId}/students` 刷新选课学生列表

## 错误处理

### 常见错误响应：
1. **401 Unauthorized**: Token 无效或缺失
2. **403 Forbidden**: 权限不足（学生尝试选课）
3. **404 Not Found**: 课程或学生不存在
4. **409 Conflict**: 学生已经选课

### 错误响应格式：
```json
{
  "error": "错误类型",
  "message": "错误描述"
}
```

## 性能考虑

1. **数据验证**: 在内存中进行，避免不必要的数据库查询
2. **批量操作**: 支持批量选课（可扩展）
3. **日志记录**: 自动记录所有选课操作，便于审计

## 安全性

1. **Token 验证**: 所有操作都需要有效的 Token
2. **权限检查**: 严格验证用户角色
3. **数据验证**: 验证课程和学生 ID 的有效性
4. **防重复**: 防止同一学生重复选课

## 后续优化建议

1. **批量选课**: 支持一次选择多个学生进行选课
2. **班级批量选课**: 支持按班级批量选课
3. **选课时间限制**: 添加选课时间段控制
4. **选课人数限制**: 限制每门课程的最大选课人数
5. **选课冲突检测**: 检测时间冲突等

## 部署说明

### 编译
```bash
./build.sh
```

### 运行
```bash
./main
```

### 测试
```bash
./test_enrollment.sh
```

## 总结

后端已成功实现学生选课功能，提供了完整的 RESTful API 接口，支持前端的选课管理需求。所有功能经过测试验证，可以与前端无缝配合使用。